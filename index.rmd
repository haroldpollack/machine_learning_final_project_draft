---
title: "harold_floundering20180809"
author: "Harold Pollack"
date: "8/10/2018"
output: html_document
---

##
##   loading required libraries
##
This is Harold Pollack's final assignment. 

This assignment asked us to develop a classifier to distinguish five exercise modes, labeled A-E, as practiced by six identified users. The training set contained 19,622 examples and some 189 variables.  We then were asked to predict exercise modes within a test set of 20 examples.

I used this as an opportunity to investigate several classifiers. Three are presented here: (1) one-vs-all logistic regression classifiers; (2) classification trees, and (3) random forest. I also explored lda and support vector machine approaches, but the results aren't shown in this document. I learned a lot doing this assignment--including that I have major hesitancy to commit on GitHub.

Each of the classifiers provided insight. Random forest provided by far the most accurate fit to the training set. 

Somewhat unfortunately, one factor variable—a timestamp—was by far the most important in predicting exercise mode. If I had greater time, I would have implemented a cross-validation set to explore the over-fitting issue. It appeared clear from a simple cross-tab of the time stamp with outcomes that the time-stamp was super-predictive.


```{R initialize libraries, warning=FALSE,message=FALSE}
library("caret", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("dbplyr", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("e1071", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("gbm", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("Hmisc", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("ISLR", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("randomForest", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("rpart", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("rpart.plot", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("tidyverse", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
```

##
## load training and testing datasets. 
##
Here are also some cross-tabs 
```{R read datasets and descriptives}
pml_training <- read.csv("pml-training.csv")
pml_testing <- read.csv("pml-testing.csv")
table(pml_training$classe)
table(pml_training$classe,pml_training$user_name)
table(pml_training$classe,pml_training$cvtd_timestamp)
```
##
##
## Now set up classe dummies for one vs all
##
```{R set up classe dummies for one vs. all}
pml_training$classe_A <- as.numeric(pml_training$classe=="A")
pml_training$classe_B <- as.numeric(pml_training$classe=="B")
pml_training$classe_C <- as.numeric(pml_training$classe=="C")
pml_training$classe_D <- as.numeric(pml_training$classe=="D")
pml_training$classe_E <- as.numeric(pml_training$classe=="E")
```

```{R user names in training set}
##
## user name dummies in training set
##
pml_training$d_adelmo<-as.numeric((pml_training$user_name=="adelmo"))
pml_training$d_charles<-as.numeric((pml_training$user_name=="charles"))
pml_training$d_carlitos<-as.numeric((pml_training$user_name=="carlitos"))
pml_training$d_eurico<-as.numeric((pml_training$user_name=="eurico"))
pml_training$d_jeremy<-as.numeric((pml_training$user_name=="jeremy"))
pml_training$d_pedro<-as.numeric((pml_training$user_name=="pedro"))
```

##
## (User name dummies in test set)
##
```{R user names in test set}
pml_testing$d_adelmo<-as.numeric((pml_testing$user_name=="adelmo"))
pml_testing$d_charles<-as.numeric((pml_testing$user_name=="charles"))
pml_testing$d_carlitos<-as.numeric((pml_testing$user_name=="carlitos"))
pml_testing$d_eurico<-as.numeric((pml_testing$user_name=="eurico"))
pml_testing$d_jeremy<-as.numeric((pml_testing$user_name=="jeremy"))
pml_testing$d_pedro<-as.numeric((pml_testing$user_name=="pedro"))
```
##
## (Time stamps)
##
``` {R time stamps, echo=FALSE}
pml_training$cvtd_timestamp_d1 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:58")    
 pml_testing$cvtd_timestamp_d1 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:58")    
pml_training$cvtd_timestamp_d2 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:58")    
 pml_testing$cvtd_timestamp_d2 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:58")    
pml_training$cvtd_timestamp_d3 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:58")    
 pml_testing$cvtd_timestamp_d3 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:58")    
pml_training$cvtd_timestamp_d4 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:58")    
 pml_testing$cvtd_timestamp_d4 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:58")    
pml_training$cvtd_timestamp_d5 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:58")    
 pml_testing$cvtd_timestamp_d5 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:58")    
pml_training$cvtd_timestamp_d6 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:58")    
 pml_testing$cvtd_timestamp_d6 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:58")    
 
pml_training$cvtd_timestamp_d7 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:58")    
 pml_testing$cvtd_timestamp_d7 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:58")    
 pml_training$cvtd_timestamp_d8 <- as.numeric(pml_training$cvtd_timestamp=="02/12/2011 14:59") 
 pml_testing$cvtd_timestamp_d8 <- as.numeric(pml_testing$cvtd_timestamp=="02/12/2011 14:59") 
 pml_training$cvtd_timestamp_d9 <- as.numeric(pml_training$cvtd_timestamp=="05/12/2011 11:23") 
 pml_testing$cvtd_timestamp_d9 <- as.numeric(pml_testing$cvtd_timestamp=="05/12/2011 11:23") 
 pml_training$cvtd_timestamp_d10 <- as.numeric(pml_training$cvtd_timestamp=="05/12/2011 11:24") 
 pml_testing$cvtd_timestamp_d10 <- as.numeric(pml_testing$cvtd_timestamp=="05/12/2011 11:24") 
 pml_training$cvtd_timestamp_d11 <- as.numeric(pml_training$cvtd_timestamp=="05/12/2011 11:25") 
 pml_testing$cvtd_timestamp_d11 <- as.numeric(pml_testing$cvtd_timestamp=="05/12/2011 11:25") 
 pml_training$cvtd_timestamp_d12 <- as.numeric(pml_training$cvtd_timestamp=="05/12/2011 14:22") 
 pml_testing$cvtd_timestamp_d12 <- as.numeric(pml_testing$cvtd_timestamp=="05/12/2011 14:22") 
 pml_training$cvtd_timestamp_d13 <- as.numeric(pml_training$cvtd_timestamp=="05/12/2011 14:23") 
 pml_testing$cvtd_timestamp_d13 <- as.numeric(pml_testing$cvtd_timestamp=="05/12/2011 14:23") 
 pml_training$cvtd_timestamp_d14 <- as.numeric(pml_training$cvtd_timestamp=="05/12/2011 14:24") 
 pml_testing$cvtd_timestamp_d14 <- as.numeric(pml_testing$cvtd_timestamp=="05/12/2011 14:24") 
 pml_testing$cvtd_timestamp_d15 <- as.numeric(pml_testing$cvtd_timestamp=="28/11/2011 14:13") 
 pml_training$cvtd_timestamp_d15 <- as.numeric(pml_training$cvtd_timestamp=="28/11/2011 14:13") 
 pml_training$cvtd_timestamp_d16 <- as.numeric(pml_training$cvtd_timestamp=="28/11/2011 14:14") 
 pml_testing$cvtd_timestamp_d16 <- as.numeric(pml_testing$cvtd_timestamp=="28/11/2011 14:14") 
 pml_training$cvtd_timestamp_d17 <- as.numeric(pml_training$cvtd_timestamp=="28/11/2011 14:15") 
 pml_testing$cvtd_timestamp_d17 <- as.numeric(pml_testing$cvtd_timestamp=="28/11/2011 14:15") 
 pml_training$cvtd_timestamp_d18 <- as.numeric(pml_training$cvtd_timestamp=="30/11/2011 17:10") 
 pml_testing$cvtd_timestamp_d18 <- as.numeric(pml_testing$cvtd_timestamp=="30/11/2011 17:10") 
 pml_training$cvtd_timestamp_d19 <- as.numeric(pml_training$cvtd_timestamp=="30/11/2011 17:11") 
 pml_testing$cvtd_timestamp_d19 <- as.numeric(pml_testing$cvtd_timestamp=="30/11/2011 17:11") 
 pml_training$cvtd_timestamp_d20 <- as.numeric(pml_training$cvtd_timestamp=="30/11/2011 17:12") 
 pml_testing$cvtd_timestamp_d20 <- as.numeric(pml_testing$cvtd_timestamp=="30/11/2011 17:12")  
```

##
## (Time stamp and username as factor)
##
```{R time stamp factor, echo=FALSE}
pml_training$cvtd_timestamp.f<-as.factor(pml_training$cvtd_timestamp)
pml_testing$cvtd_timestamp.f<-as.factor(pml_testing$cvtd_timestamp)
pml_training$user_name.f<-as.factor(pml_training$user_name)
pml_testing$user_name.f<-as.factor(pml_testing$user_name)
table(pml_training$user_name.f)
```

##
## one vs all
##
Now I implemented a one vs. all classifier.
```{R one vs. all classifier, echo=FALSE, warning=FALSE}
dlogit_classe_A <- glm(as.factor(classe_A) ~ roll_dumbbell + pitch_dumbbell+yaw_dumbbell+total_accel_belt+gyros_arm_x+gyros_arm_y+gyros_arm_z+magnet_forearm_x+magnet_forearm_y+magnet_forearm_z+d_adelmo+d_charles+d_carlitos+d_eurico+d_adelmo+d_jeremy+d_pedro+cvtd_timestamp_d1+cvtd_timestamp_d2+cvtd_timestamp_d3+cvtd_timestamp_d4+cvtd_timestamp_d5+cvtd_timestamp_d6+cvtd_timestamp_d7+cvtd_timestamp_d8+cvtd_timestamp_d9+cvtd_timestamp_d10+cvtd_timestamp_d11+cvtd_timestamp_d12+cvtd_timestamp_d13+cvtd_timestamp_d14+cvtd_timestamp_d15+cvtd_timestamp_d16+cvtd_timestamp_d17+cvtd_timestamp_d18+cvtd_timestamp_d19+cvtd_timestamp_d20 , data=pml_training, family=binomial(link="logit"))

dlogit_classe_B <- glm(as.factor(classe_B) ~ roll_dumbbell + pitch_dumbbell+yaw_dumbbell+total_accel_belt+gyros_arm_x+gyros_arm_y+gyros_arm_z+magnet_forearm_x+magnet_forearm_y+magnet_forearm_z+d_adelmo+d_charles+d_carlitos+d_eurico+d_adelmo+d_jeremy+d_pedro+cvtd_timestamp_d1+cvtd_timestamp_d2+cvtd_timestamp_d3+cvtd_timestamp_d4+cvtd_timestamp_d5+cvtd_timestamp_d6+cvtd_timestamp_d7+cvtd_timestamp_d8+cvtd_timestamp_d9+cvtd_timestamp_d10+cvtd_timestamp_d11+cvtd_timestamp_d12+cvtd_timestamp_d13+cvtd_timestamp_d14+cvtd_timestamp_d15+cvtd_timestamp_d16+cvtd_timestamp_d17+cvtd_timestamp_d18+cvtd_timestamp_d19+cvtd_timestamp_d20 , data=pml_training, family=binomial(link="logit"))

dlogit_classe_C <- glm(as.factor(classe_C) ~ roll_dumbbell + pitch_dumbbell+yaw_dumbbell+total_accel_belt+gyros_arm_x+gyros_arm_y+gyros_arm_z+magnet_forearm_x+magnet_forearm_y+magnet_forearm_z+d_adelmo+d_charles+d_carlitos+d_eurico+d_adelmo+d_jeremy+d_pedro+cvtd_timestamp_d1+cvtd_timestamp_d2+cvtd_timestamp_d3+cvtd_timestamp_d4+cvtd_timestamp_d5+cvtd_timestamp_d6+cvtd_timestamp_d7+cvtd_timestamp_d8+cvtd_timestamp_d9+cvtd_timestamp_d10+cvtd_timestamp_d11+cvtd_timestamp_d12+cvtd_timestamp_d13+cvtd_timestamp_d14+cvtd_timestamp_d15+cvtd_timestamp_d16+cvtd_timestamp_d17+cvtd_timestamp_d18+cvtd_timestamp_d19+cvtd_timestamp_d20 , data=pml_training, family=binomial(link="logit"))

dlogit_classe_D <- glm(as.factor(classe_D) ~ roll_dumbbell + pitch_dumbbell+yaw_dumbbell+total_accel_belt+gyros_arm_x+gyros_arm_y+gyros_arm_z+magnet_forearm_x+magnet_forearm_y+magnet_forearm_z+d_adelmo+d_charles+d_carlitos+d_eurico+d_adelmo+d_jeremy+d_pedro+cvtd_timestamp_d1+cvtd_timestamp_d2+cvtd_timestamp_d3+cvtd_timestamp_d4+cvtd_timestamp_d5+cvtd_timestamp_d6+cvtd_timestamp_d7+cvtd_timestamp_d8+cvtd_timestamp_d9+cvtd_timestamp_d10+cvtd_timestamp_d11+cvtd_timestamp_d12+cvtd_timestamp_d13+cvtd_timestamp_d14+cvtd_timestamp_d15+cvtd_timestamp_d16+cvtd_timestamp_d17+cvtd_timestamp_d18+cvtd_timestamp_d19+cvtd_timestamp_d20 , data=pml_training, family=binomial(link="logit"))

dlogit_classe_E <- glm(as.factor(classe_E) ~ roll_dumbbell + pitch_dumbbell+yaw_dumbbell+total_accel_belt+gyros_arm_x+gyros_arm_y+gyros_arm_z+magnet_forearm_x+magnet_forearm_y+magnet_forearm_z+d_adelmo+d_charles+d_carlitos+d_eurico+d_adelmo+d_jeremy+d_pedro+cvtd_timestamp_d1+cvtd_timestamp_d2+cvtd_timestamp_d3+cvtd_timestamp_d4+cvtd_timestamp_d5+cvtd_timestamp_d6+cvtd_timestamp_d7+cvtd_timestamp_d8+cvtd_timestamp_d9+cvtd_timestamp_d10+cvtd_timestamp_d11+cvtd_timestamp_d12+cvtd_timestamp_d13+cvtd_timestamp_d14+cvtd_timestamp_d15+cvtd_timestamp_d16+cvtd_timestamp_d17+cvtd_timestamp_d18+cvtd_timestamp_d19+cvtd_timestamp_d20 , data=pml_training, family=binomial(link="logit"))


##
## predicted probabilities
##

pred_A_training<-predict(dlogit_classe_A,pml_training,type="response")
pred_B_training<-predict(dlogit_classe_B,pml_training,type="response")
pred_C_training<-predict(dlogit_classe_C,pml_training,type="response")
pred_D_training<-predict(dlogit_classe_D,pml_training,type="response")
pred_E_training<-predict(dlogit_classe_E,pml_training,type="response")

pred_A_testing<-predict(dlogit_classe_A,pml_testing,type="response")
pred_B_testing<-predict(dlogit_classe_B,pml_testing,type="response")
pred_C_testing<-predict(dlogit_classe_C,pml_testing,type="response")
pred_D_testing<-predict(dlogit_classe_D,pml_testing,type="response")
pred_E_testing<-predict(dlogit_classe_E,pml_testing,type="response")

##
## find maximum
##

pml_training$pred_probs_training<-data.frame(A=pred_A_training,B=pred_B_training,C=pred_C_training,D=pred_D_training,E=pred_E_training)
pml_training$pmax_training<-apply(pml_training$pred_probs_training,1,which.max)

pml_testing$pred_probs_testing<-data.frame(A=pred_A_testing,B=pred_B_testing,C=pred_C_testing,D=pred_D_testing,E=pred_E_testing)
pml_testing$pmax_testing<-apply(pml_testing$pred_probs_testing,1,which.max)
table(pml_training$pmax_training,pml_training$classe)
```

##
## Classification trees--complete with cool diagram.
##
One interesting aspect here was that I had originally coded the timestamp as a series of dummy variables. The resulting classifier was notably worse. Note that the tree report is pretty opaque compared with the rpart.plot.

```{R classification trees}
tree_classe_rpart4_training <- rpart(classe ~ roll_dumbbell + pitch_dumbbell+yaw_dumbbell+total_accel_belt+gyros_arm_x+gyros_arm_y+gyros_arm_z+magnet_forearm_x+magnet_forearm_y+magnet_forearm_z+d_adelmo+d_charles+d_carlitos+d_eurico+d_jeremy+cvtd_timestamp.f, data=pml_training)
tree_classe_rpart4_training
rpart.plot(tree_classe_rpart4_training)
pred_classe4_rpart_training <- predict(tree_classe_rpart4_training, type="class",data=pml_training)
table(pred_classe4_rpart_training)
table(pred_classe4_rpart_training,pml_training$classe)
pred_classe4_rpart_testing <- predict(tree_classe_rpart4_training, type="class",data=pml_testing)
table(pred_classe4_rpart_testing)
```

##
## Random Forest
##
This was by-far the most accurate classifier I was able to implement.If I had more time, I would have implemented a cross-validation set to explore the over-fitting issue. Note the dominance of the time stamp in the variable importance plot.
```{R random forest}
rf.tree_classe_ <- randomForest(classe ~ roll_dumbbell + pitch_dumbbell+yaw_dumbbell+total_accel_belt+gyros_arm_x+gyros_arm_y+gyros_arm_z+magnet_forearm_x+magnet_forearm_y+magnet_forearm_z+user_name+cvtd_timestamp.f, data=pml_training)

pred_classe_rf=predict(rf.tree_classe_)
table(pred_classe_rf)
table(pred_classe_rf,pml_training$classe)
# pred_classe_rf_testing=predict(rf.tree_classe_,pml_testing)
importance(rf.tree_classe_)
varImpPlot(rf.tree_classe_)
```

Now let's show some comparisons of the classifiers
```{R comparing classifiers}
##
## classification tree vs random forest
##
table(pred_classe4_rpart_training,pred_classe_rf)
# table(pred_classe4_rpart_testing,pred_classe_rf_testing)
##
## classification tree vs one vs all
##
table(pml_training$pmax_training,pred_classe_rf)
# table(pml_testing$pmax_testing,pred_classe_rf_testing)